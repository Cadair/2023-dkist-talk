#+REVEAL_ROOT: ./src/reveal.js/
#+REVEAL_MATHJAX_URL: ./src/mathjax/es5/tex-chtml.js
#+REVEAL_HIGHLIGHT_CSS: %r/plugin/highlight/monokai.css
#+REVEAL_PLUGINS: (notes highlight)
#+REVEAL_THEME: simple
#+REVEAL_DEFAULT_SLIDE_BACKGROUND: ./images/filt_Gband1_yellow1_1920.jpg
#+REVEAL_DEFAULT_SLIDE_BACKGROUND_OPACITY: 0.2
#+OPTIONS: toc:nil
#+OPTIONS: num:nil
#+OPTIONS: reveal_title_slide:nil
#+REVEAL_EXTRA_CSS: org.css
#+REVEAL_INIT_OPTIONS: hash: true, slideNumber: "c/t", showSlideNumber: 'speaker', center: false

* DKIST Level 1 Data and Using it in Python
:PROPERTIES:
:CUSTOM_ID: title
:reveal_extra_attr: class="title"
:reveal_background: ./images/vbi_blue_hires.jpg
:reveal_background_opacity: 1
:reveal_background_position: top
:END:

#+REVEAL_HTML: <h3 style="padding-bottom: 20%;"> Stuart Mumford </h3>
#+REVEAL_HTML: <a href="https://aperio.software"><img style='float: left; width: 20%; margin-top: 100px; height: 15%;' src='images/aperio.svg'/></a><a href="https://nso.edu"><img style='float: right; width: 20%; margin-top: 60px; height: 15%; margin-right: 5%%;' src='images/NSO-logo-blue.png'/></a>

* The Inouye Solar Telescope
:PROPERTIES:
:CUSTOM_ID: dkist
:reveal_background: ./images/dkist-exterior.jpg
:reveal_background_opacity: 0.8
:END:
#+BEGIN_NOTES
- VISP is a slit-spectrograph with polarimitery.
- VBI is a dual-channel broadband imager.
#+END_NOTES

#+REVEAL_HTML: <div class='left' style='width: 60%; margin-left:-5em;font-weight: bolder;'>
- At the Haleakalā Observatory on the island of Maui.
- The largest mirror of any solar telescope in the world - 4 meters.
- First solar images captured by the observatory in late 2019.
- Will be operational for at least 44 years – or four solar cycles.
- Two instruments currently on-line:
  - Visible Spectropolarimeter (VISP)
  - Visible Broadband Imager (VBI)
- Three more instruments coming on-line:
  - Cryogenic Near Infrared Spectropolarimeter (Cryo-NIRSP)
  - Diffraction Limited Near Infrared Spectropolarimeter (DL-NIRSP)
  - Visible Tunable Filter (VTF)
#+REVEAL_HTML: </div>

* Python Tools
:PROPERTIES:
:CUSTOM_ID: python
:END:
#+BEGIN_NOTES
- ~dkist~ package aims to make it easy to get and load DKIST data.
- Also a place for the community to collaborate on DKIST-specifc analysis tools.
#+END_NOTES

#+REVEAL_HTML: <div class='left'>

- ~dkist~ package available now on PyPI and conda-forge.
- Developed openly on GitHub since the start.
- Provides:
  - a plugin for SunPy's Fido to search datasets,
  - helpers for downloading FITS files with Globus,
  - A ~Dataset~ class based on ~NDCube~.
- Uses ~dask~ to delay I/O of FITS files.
- Uses ~gWCS~ to represent the coordinates of the whole dataset.

#+attr_html: :width 80%
[[./images/dkist-repo-overview.png]]
#+REVEAL_HTML: </div>

#+REVEAL_HTML: <div class='right'>

#+attr_html: :width 90%
[[./images/vbi_plot.png]]

#+REVEAL_HTML: </div>

* Level One Data
:PROPERTIES:
:CUSTOM_ID: datasets
:END:
#+BEGIN_NOTES
A dataset is the result of a calibration run, and can be loaded into a single array.
#+END_NOTES

The data holdings at the DKIST Data Center are catalogued in unique "datasets".

#+BEGIN_QUOTE
A dataset broadly consists of a continuous set of observations taken by a single instrument, at a single pass band, with similar instrument parameters.
#+END_QUOTE

This means that a dataset can contain a wide variety of data, such as, slit-spectra, imaging, spectropolarimetic data etc.

#+attr_html: :width 100%
[[./images/portal_results.png]]

** Makeup of a dataset
:PROPERTIES:
:CUSTOM_ID: datasets-layout
:END:
#+BEGIN_NOTES
- Many FITS - current max 33,000 - 100s of 1000s possible
- Each FITS file has a well documented header with information about where that file sits in the dataset array.
#+END_NOTES

- Each "calibrated exposure" is in a FITS file with a complete header.
- Each dataset contains /many/ FITS files (current max is 33,000).
- To reconstruct these files into a multi-dim array we need to /order/ them.

** ASDF Files
:PROPERTIES:
:CUSTOM_ID: datasets-layout
:END:
#+BEGIN_NOTES
- What is an ASDF file.
- What's in the ASDF file.
- Why the ASDF file.
#+END_NOTES

#+ATTR_REVEAL: :frag (fade-in)
- Advanced Scientific Data Format (ASDF) is a new file format with more flexible metadata than FITS.
- Powerful Python library, and initial support in C++ and IDL.
- Used heavily by JWST data.
- DKIST ASDF files contain:
  - A copy of all the FITS headers for all files.
  - A copy of the inventory record which is searchable via the DKIST data search API.
  - An ordered list of filenames, and information about the array, such as dtype and shape.
  - A gWCS object representing world coordinates for the whole dataset array.

** Search and Download - Data / Metadata Separation
:PROPERTIES:
:CUSTOM_ID: challenge-download
:END:
#+BEGIN_NOTES
- From the web data portal it's only possible to download complete datasets.
#+END_NOTES
#+BEGIN_QUOTE
How can we make it possible to download a subset of the data based on metadata.
#+END_QUOTE

The scale of the DKIST datasets mean that pre-processing them before download is not feasible.

Maximum flexibility is achieved by facilitating download based on all metadata.

Arbitrary queries based on all available metadata is a complex problem for a web service.

*** Search for metadata data
:PROPERTIES:
:CUSTOM_ID: search-and-download
:END:
#+BEGIN_NOTES
- In this example we access the full table of FITS headers and use those headers to decide where the good seeing ends.
#+END_NOTES

The DKIST search portal and ~dkist~ package allow searching based on a limited subset of all metadata.

Downloading the ASDF file gives you a /complete/ set of metadata for all files contained in a dataset.

#+BEGIN_SRC python
# Select headers for only frames with bad r0
bad_headers = ds.headers[ds.headers["ATMOS_R0"] > 1]

# Slice up to the index of the first bad frame
sds = ds[0, :bad_headers[0]["DINDEX3"]-1, :, :]

# Download only files with good seeing.
sds.files.download(path="~/dkist/data/{dataset_id}/")
#+END_SRC


** Too many files - Dask and delayed IO
:PROPERTIES:
:CUSTOM_ID: delayed-io
:END:
#+BEGIN_NOTES
- Given a whole set of FITS files you could open them all and parse the headers.
- Much quicker to read the ASDF file which already contains the metadata needed.
- Dask is a project designed to parallelise Python code.
#+END_NOTES

#+BEGIN_QUOTE
You think you can open 10s or 100s of thousands files at once, but you just can't.
#+END_QUOTE

Rather than opening all the files to read the headers to reconstruct the whole array, we read the "recipe" for the array from the ASDF file.

We build an array comprised of all the arrays in the FITS files, but it's "delayed" by using ~dask~, so the files are only opened on demand.

#+attr_html: :width 90%
[[./images/dask-repr.png]]

*** Delayed Compute
:PROPERTIES:
:CUSTOM_ID: distributed
:END:
#+BEGIN_NOTES
- Computation of the array isn't triggered until it's needed or you do it explicitly.
- Here we do a rebinning operation and then trigger the compute.
- Dask can schedule compute in parallel, locally, on the cloud or on HPC clusters
#+END_NOTES

#+BEGIN_SRC python
ds = dkist.load_dataset("~/dkist/AGLKO/")
rebinned_ds = ds[0, ..., :-5].rebin((10, 1, 10))
computed_data = rebinned_ds.data.compute()
#+END_SRC

#+attr_html: :width 90%
[[./images/dask-distributed-rebin.png]]

* Current and Future Status
:PROPERTIES:
:CUSTOM_ID: status
:END:

#+BEGIN_QUOTE
~dkist~ v1.0.0 is close to release (couple of weeks away).
#+END_QUOTE

*Features Implemented in v1.0.0:*

- Reading ASDF files into ~Dataset~ objects.
- A SunPy Fido client for searching DKIST datasets.
- Helpers for making Globus data downloads easier.
- Extensions to the ~NDCube~ API for working with the collection of FITS files.
- Internal functionality for building ~dask~ arrays from many FITS files.

*Upcoming development:*

- Fixing use of ~Dataset.crop~ for slicing based on world coordinates.
- Helpers and documentation for modifying Datasets (i.e. shifting pointing).
- Performance improvements, on transforms and data loading.
- Better tools for working with VBI mosaics.

* Thank You

#+REVEAL_HTML: <div class='left'>

Find me online:

 [[https://cadair.com][cadair.com]]

 [[https://matrix.to/#/@cadair:cadair.com][@cadair:cadair.com]] on Matrix

 [[https://mastodon.matrix.org/@Cadair][@Cadair@mastodon.matrix.org]] on Mastodon

 [[https://github.com/Cadair][@Cadair]] on GitHub

#+REVEAL_HTML: </div>

#+REVEAL_HTML: <div class='right'>

#+attr_html: :width 500px
[[./images/cadair.jpg]]

#+REVEAL_HTML: </div>
